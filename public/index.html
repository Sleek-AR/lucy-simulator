<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Lucy Bewerbungssimulator</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        overflow: hidden;
      }
      #overlay {
        position: fixed;
        bottom: 0;
        left: 0;
        background: rgba(255, 255, 255, 0.95);
        width: 100%;
        padding: 1rem;
        box-sizing: border-box;
        z-index: 100;
        display: none;
      }
      #log {
        height: 150px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        background: #fff;
        margin-bottom: 10px;
      }
      button {
        font-size: 16px;
        padding: 10px 20px;
      }
    </style>
  </head>
  <body>
    <a-scene background="color: #ECECEC">
      <a-assets>
        <a-asset-item id="lucyModel" src="https://models.readyplayer.me/6823269dbdbf61e0facd5a12.glb"></a-asset-item>
      </a-assets>

      <a-light type="ambient" intensity="1.0"></a-light>

      <a-entity id="cameraRig">
        <a-camera position="0 1.6 0"
                  raycaster="objects: .clickable"
                  cursor="rayOrigin: mouse">
          <a-entity cursor="rayOrigin: mouse"
                    geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                    material="color: black; shader: flat"
                    position="0 0 -1">
          </a-entity>
        </a-camera>
      </a-entity>

      <a-entity
        id="lucy"
        gltf-model="#lucyModel"
        position="0 0 -2"
        scale="1.5 1.5 1.5"
        animation__speak="property: scale; to: 1.55 1.45 1.55; dir: alternate; dur: 200; loop: true; startEvents: speak; pauseEvents: stopspeak"
      ></a-entity>

      <a-entity id="thinkingText"
                text="value: Lucy denkt nach...; align: center; color: #555"
                position="0 2.8 -2"
                visible="false">
        <a-animation attribute="material.opacity"
                     from="0.3" to="1"
                     dur="1000"
                     direction="alternate"
                     repeat="indefinite">
        </a-animation>
      </a-entity>

      <a-entity id="recordButton"
                geometry="primitive: plane; height: 0.3; width: 1.4"
                material="color: #00BFFF"
                position="0 1 -1.5"
                text="value: üéô Aufnahme starten; align: center"
                class="clickable"
                event-set__enter="_event: mouseenter; material.color: #FFD700"
                event-set__leave="_event: mouseleave; material.color: #00BFFF">
      </a-entity>
    </a-scene>

    <div id="overlay">
      <div id="log">üí¨ Lucy wartet auf deine Stimme...</div>
      <button id="startBtn">üî¥ Aufnahme starten</button>
    </div>

    <script>
      const log = document.getElementById("log");
      const lucy = document.getElementById("lucy");
      const recordButton = document.getElementById("recordButton");
      const thinkingText = document.getElementById("thinkingText");

      let mediaRecorder;
      let audioChunks = [];
      let isRecording = false;

      function append(msg) {
        log.innerHTML += "<div>" + msg + "</div>";
        log.scrollTop = log.scrollHeight;
      }

      async function playVoiceFromText(text) {
        try {
          const response = await fetch("/tts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
          });
          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          lucy.emit("speak");
          thinkingText.setAttribute("visible", false);
          audio.play();
          audio.onended = () => lucy.emit("stopspeak");
        } catch (error) {
          console.error("TTS-Fehler:", error);
          append("‚ö†Ô∏è Konnte Antwort nicht abspielen.");
          thinkingText.setAttribute("visible", false);
        }
      }

      function speak(text) {
        playVoiceFromText(text);
      }

      recordButton.addEventListener("click", async () => {
        if (!isRecording) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
            audioChunks = [];

            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

            mediaRecorder.onstop = async () => {
              append("üõë Aufnahme gestoppt.");
              const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
              const formData = new FormData();
              formData.append("audio", audioBlob, "speech.webm");

              append("‚è≥ Sende Audio an Server...");
              thinkingText.setAttribute("visible", true);

              try {
                const res = await fetch("/upload-audio", {
                  method: "POST",
                  body: formData
                });

                const data = await res.json();
                const reply = data.response || data.error || "Fehler bei Antwort";

                append("ü§ñ <b>Lucy:</b> " + reply);
                speak(reply);
              } catch (error) {
                console.error("Upload-Fehler:", error);
                append("‚ùå Fehler beim Senden oder Verarbeiten.");
                thinkingText.setAttribute("visible", false);
              }
            };

            mediaRecorder.start();
            isRecording = true;
            recordButton.setAttribute("material", "color", "#FF4136");
            recordButton.setAttribute("text", "value", "‚èπÔ∏è Aufnahme stoppen");
            append("üéôÔ∏è Aufnahme l√§uft...");
          } catch (err) {
            console.error("Mikrofon-Fehler:", err);
          }
        } else {
          if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            isRecording = false;
            recordButton.setAttribute("material", "color", "#00BFFF");
            recordButton.setAttribute("text", "value", "üéô Aufnahme starten");
          } else {
            console.warn("‚ö†Ô∏è mediaRecorder war nicht im Aufnahmezustand.");
          }
        }
      });
    </script>
  </body>
</html>

