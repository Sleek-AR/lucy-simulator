<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Lucy Bewerbungssimulator</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        overflow: hidden;
      }
      #overlay {
        position: fixed;
        bottom: 0;
        left: 0;
        background: rgba(255, 255, 255, 0.95);
        width: 100%;
        padding: 1rem;
        box-sizing: border-box;
        z-index: 100;
      }
      #log {
        height: 150px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        background: #fff;
        margin-bottom: 10px;
      }
      button {
        font-size: 16px;
        padding: 10px 20px;
      }
    </style>
  </head>
  <body>
    <!-- VR/3D Szene -->
    <a-scene background="color: #ECECEC">
      <a-assets>
        <a-asset-item
          id="lucyModel"
          src="https://models.readyplayer.me/6823269dbdbf61e0facd5a12.glb"
        ></a-asset-item>
      </a-assets>

      <a-light type="ambient" intensity="1.0"></a-light>
      <a-camera position="0 1.6 0"></a-camera>

      <a-entity
        id="lucy"
        gltf-model="#lucyModel"
        position="0 0 -2"
        scale="1.5 1.5 1.5"
        animation__speak="property: scale; to: 1.55 1.45 1.55; dir: alternate; dur: 200; loop: true; startEvents: speak; pauseEvents: stopspeak"
      ></a-entity>
    </a-scene>

    <!-- Sprachinterface -->
    <div id="overlay">
      <div id="log">üí¨ Lucy wartet auf deine Stimme...</div>
      <button id="startBtn">üî¥ Aufnahme starten</button>
    </div>

    <script>
      const log = document.getElementById("log");
      const button = document.getElementById("startBtn");
      const lucy = document.getElementById("lucy");

      let mediaRecorder;
      let audioChunks = [];
      let isRecording = false;

      function append(msg) {
        log.innerHTML += "<div>" + msg + "</div>";
        log.scrollTop = log.scrollHeight;
      }

      function speak(text) {
        if ("speechSynthesis" in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "de-DE";
          utterance.onstart = () => lucy.emit("speak");
          utterance.onend = () => lucy.emit("stopspeak");
          speechSynthesis.speak(utterance);
        } else {
          append("‚ö†Ô∏è Sprachausgabe nicht unterst√ºtzt.");
        }
      }

      button.onclick = async () => {
        if (!isRecording) {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

          mediaRecorder.onstop = async () => {
            append("üõë Aufnahme gestoppt.");
            const audioBlob = new Blob(audioChunks, { type: "audio/webm;codecs=opus" }); // üëà hier der Fix
            const formData = new FormData();
            formData.append("audio", audioBlob, "speech.webm");

            append("‚è≥ Sende Audio an Server...");

            try {
              const res = await fetch("https://lucy-simulator.onrender.com/upload-audio", {
                method: "POST",
                body: formData,
              });

              const data = await res.json();
              const reply = data.response || data.error || "Fehler bei Antwort";

              append("ü§ñ <b>Lucy:</b> " + reply);
              speak(reply);
            } catch (error) {
              console.error("Upload-Fehler:", error);
              append("‚ùå Fehler beim Senden oder Verarbeiten.");
            }
          };

          mediaRecorder.start();
          isRecording = true;
          button.textContent = "‚èπÔ∏è Aufnahme stoppen";
          append("üéôÔ∏è Aufnahme l√§uft...");
        } else {
          mediaRecorder.stop();
          isRecording = false;
          button.textContent = "üî¥ Aufnahme starten";
        }
      };
    </script>
  </body>
</html>
