<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Lucy Bewerbungssimulator</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    <script>
      AFRAME.registerComponent("enable-controls", {
        init: function () {
          this.el.setAttribute("movement-controls", {
            fly: false,
            speed: 0.1,
          });
          this.el.setAttribute("wasd-controls-enabled", false);
        },
      });

      AFRAME.registerComponent("move-rig-with-thumbstick", {
        schema: { speed: { type: "number", default: 0.1 } },
        init: function () {
          this.rig = document.querySelector("#cameraRig");
          this.camera = document.querySelector("#camera");
          this.direction = new THREE.Vector3();
          this.el.addEventListener("thumbstickmoved", (e) => {
            this.direction.set(e.detail.x, 0, e.detail.y);
            this.direction.multiplyScalar(this.data.speed);
            const camQuat = this.camera.object3D.quaternion;
            this.direction.applyQuaternion(camQuat);
            this.rig.object3D.position.add(this.direction);
          });
        },
      });

      // Bewegung per Tastatur nur in Webmodus aktivieren
      window.addEventListener("DOMContentLoaded", () => {
        const scene = document.querySelector("a-scene");
        const camera = document.getElementById("camera");

        scene.addEventListener("enter-vr", () => {
          camera.setAttribute("wasd-controls-enabled", false);
        });

        scene.addEventListener("exit-vr", () => {
          camera.setAttribute("wasd-controls-enabled", true);
        });
      });
    </script>

    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        overflow: hidden;
      }
      #log {
        position: absolute;
        bottom: 0;
        width: 100%;
        max-height: 150px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        font-size: 14px;
      }
      .blinker {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 15px;
        height: 15px;
        background-color: red;
        border-radius: 50%;
        animation: blink 1s infinite;
        z-index: 9999;
        display: none;
      }
      @keyframes blink {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
      #roleSelect {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 9999;
        font-size: 16px;
        padding: 4px;
      }
    </style>
  </head>
  <body>
    <div class="blinker" id="blinker"></div>
    <select id="roleSelect">
      <option value="recruiter">Lucy Recruiter</option>
      <option value="bewerberin">Lucy Bewerberin</option>
      <option value="konflikt">Konflikttraining</option>
      <option value="telefon">Telefontraining</option>
    </select>
    <a-scene
      xr-compatible
      vr-mode-ui="enabled: true"
      background="color: #ECECEC"
    >
      <a-assets>
        <a-asset-item
          id="lucyModel"
          src="https://models.readyplayer.me/6823269dbdbf61e0facd5a12.glb"
        ></a-asset-item>
        <a-asset-item
          id="officeSet"
          src="https://raw.githubusercontent.com/Sleek-AR/lucy-simulator/main/icons8_high_chairs_blackboard_round_table.glb"
        ></a-asset-item>
      </a-assets>

      <a-light type="ambient" intensity="1.0"></a-light>
      <a-sky color="#dfe9f3"></a-sky>
      <a-plane color="#ccc" rotation="-90 0 0" width="30" height="30"></a-plane>

      <!-- KameraRig inkl. Kamera & Controller -->
      <a-entity id="cameraRig" movement-controls="speed: 0.1" position="0 0 0">
        <a-camera
          id="camera"
          wasd-controls-enabled="true"
          raycaster="objects: .clickable"
          cursor="rayOrigin: entity"
        >
          <a-entity
            cursor
            geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
            material="color: black; shader: flat"
            position="0 0 -1"
          ></a-entity>
        </a-camera>

        <!-- Controller bewegen sich mit -->
        <a-entity
          laser-controls="hand: left"
          raycaster="objects: .clickable"
          line="color: #00BFFF"
          move-rig-with-thumbstick
        ></a-entity>
        <a-entity
          laser-controls="hand: right"
          raycaster="objects: .clickable"
          line="color: #00BFFF"
          move-rig-with-thumbstick
        ></a-entity>
      </a-entity>

      <!-- Lucy -->
      <a-entity
        id="lucy"
        gltf-model="#lucyModel"
        position="0 0 -2"
        scale="1.5 1.5 1.5"
        visible="true"
        animation__speak="property: scale; to: 1.55 1.45 1.55; dir: alternate; dur: 200; loop: true; startEvents: speak; pauseEvents: stopspeak"
      ></a-entity>

      <!-- Office -->
      <a-entity
        gltf-model="#officeSet"
        position="-3 0 -6"
        scale="0.7 0.7 0.7"
        rotation="0 0 0"
      ></a-entity>

      <!-- Denktext -->
      <a-entity
        id="thinkingText"
        text="value: Lucy denkt nach...; align: center; color: #555"
        position="0 3.2 -2"
        visible="false"
      >
        <a-animation
          attribute="material.opacity"
          from="0.3"
          to="1"
          dur="1000"
          direction="alternate"
          repeat="indefinite"
        ></a-animation>
      </a-entity>

      <!-- H√∂rtext -->
      <a-entity
        id="listeningText"
        text="value: Lucy nimmt dich gerade wahr...; align: center; color: #f00"
        position="0 2.9 -2"
        visible="false"
      >
        <a-animation
          attribute="material.opacity"
          from="0.3"
          to="1"
          dur="1000"
          direction="alternate"
          repeat="indefinite"
        ></a-animation>
      </a-entity>

      <!-- Aufnahmebutton -->
      <a-entity
        id="recordButton"
        geometry="primitive: plane; height: 0.3; width: 1.4"
        material="color: #00BFFF"
        position="0 1 -1.5"
        text="value: üéô Leertaste oder Trigger halten; align: center"
        class="clickable"
      ></a-entity>

      <!-- üîΩ Raum-UI-Men√º f√ºr VR -->
      <a-entity id="vrMenu" position="2 1.5 -6">
        <a-plane
          width="1.8"
          height="1.8"
          color="#ffffff"
          opacity="0.95"
          material="shader: flat"
          position="0 0 0"
        ></a-plane>
        <a-text
          value="Die Rolle von Lucy festlegen:"
          align="center"
          color="#000"
          width="2"
          position="0 0.45 0.01"
        ></a-text>

        <a-entity
          class="clickable"
          geometry="primitive: plane; height: 0.25; width: 1.5"
          material="color: #00BFFF"
          position="0 0.2 0.01"
          event-set__enter="_event: mouseenter; material.color: #007ACC"
          event-set__leave="_event: mouseleave; material.color: #00BFFF"
          onclick="setRole('recruiter')"
        >
          <a-text
            value="Lucy Recruiter"
            align="center"
            color="#fff"
            width="1.2"
            position="0 0 0.01"
          ></a-text>
        </a-entity>

        <a-entity
          class="clickable"
          geometry="primitive: plane; height: 0.25; width: 1.5"
          material="color: #00BFFF"
          position="0 -0.1 0.01"
          event-set__enter="_event: mouseenter; material.color: #007ACC"
          event-set__leave="_event: mouseleave; material.color: #00BFFF"
          onclick="setRole('bewerberin')"
        >
          <a-text
            value="Lucy Bewerberin"
            align="center"
            color="#fff"
            width="1.2"
            position="0 0 0.01"
          ></a-text>
        </a-entity>

        <a-entity
          class="clickable"
          geometry="primitive: plane; height: 0.25; width: 1.5"
          material="color: #00BFFF"
          position="0 -0.4 0.01"
          event-set__enter="_event: mouseenter; material.color: #007ACC"
          event-set__leave="_event: mouseleave; material.color: #00BFFF"
          onclick="setRole('konflikt')"
        >
          <a-text
            value="Konflikttraining"
            align="center"
            color="#fff"
            width="1.2"
            position="0 0 0.01"
          ></a-text>
        </a-entity>

        <a-entity
          class="clickable"
          geometry="primitive: plane; height: 0.25; width: 1.5"
          material="color: #00BFFF"
          position="0 -0.7 0.01"
          event-set__enter="_event: mouseenter; material.color: #007ACC"
          event-set__leave="_event: mouseleave; material.color: #00BFFF"
          onclick="setRole('telefon')"
        >
          <a-text
            value="Telefontraining"
            align="center"
            color="#fff"
            width="1.2"
            position="0 0 0.01"
          ></a-text>
        </a-entity>

        <!-- Vereinfachter Anruf-Button -->
        <a-entity
          id="simpleCallButton"
          class="clickable"
          position="-2 0 2"
          visible="false"
        >
          <a-plane
            width="1.8"
            height="0.4"
            color="#28a745"
            material="shader: flat"
            geometry="primitive: plane"
            event-set__enter="_event: mouseenter; material.color: #218838"
            event-set__leave="_event: mouseleave; material.color: #28a745"
          >
            <a-text
              value="üìû +43 660 3262626 anrufen"
              align="center"
              color="#ffffff"
              width="2.5"
              position="0 0 0.01"
            ></a-text>
          </a-plane>
        </a-entity>
      </a-entity>
    </a-scene>

    <div id="log">üí¨ Lucy wartet auf deine Stimme...</div>

    <script>
      const log = document.getElementById("log");
      const blinker = document.getElementById("blinker");
      const lucy = document.getElementById("lucy");
      const recordButton = document.getElementById("recordButton");
      const thinkingText = document.getElementById("thinkingText");
      const listeningText = document.getElementById("listeningText");
      const roleSelect = document.getElementById("roleSelect");

      let mediaRecorder;
      let audioChunks = [];
      let micStream;
      let isRecording = false;

      function append(msg) {
        log.innerHTML += `<div>${msg}</div>`;
        log.scrollTop = log.scrollHeight;
      }

      async function playVoiceFromText(text) {
        try {
          const response = await fetch("/tts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });
          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          lucy.emit("speak");
          thinkingText.setAttribute("visible", false);
          audio.play();
          audio.onended = () => lucy.emit("stopspeak");
        } catch (error) {
          console.error("TTS-Fehler:", error);
          append("‚ö†Ô∏è Konnte Antwort nicht abspielen.");
          thinkingText.setAttribute("visible", false);
        }
      }

      function speak(text) {
        playVoiceFromText(text);
      }

      async function startRecording() {
        if (isRecording) return;
        isRecording = true;
        try {
          micStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(micStream, {
            mimeType: "audio/webm",
          });
          audioChunks = [];

          mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

          mediaRecorder.onstop = async () => {
            isRecording = false;
            append("üõë Aufnahme gestoppt.");
            blinker.style.display = "none";
            listeningText.setAttribute("visible", false);
            if (micStream) micStream.getTracks().forEach((t) => t.stop());

            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            const formData = new FormData();
            formData.append("audio", audioBlob, "speech.webm");

            append("‚è≥ Sende Audio an Server...");
            thinkingText.setAttribute("visible", true);

            try {
              const role = roleSelect.value || "recruiter";
              const res = await fetch(`/upload-audio?role=${role}`, {
                method: "POST",
                body: formData,
              });

              const data = await res.json();
              const reply = data.response || data.error || "Fehler bei Antwort";

              append("ü§ñ <b>Lucy:</b> " + reply);
              speak(reply);
            } catch (error) {
              console.error("Upload-Fehler:", error);
              append("‚ùå Fehler beim Senden oder Verarbeiten.");
              thinkingText.setAttribute("visible", false);
            }
          };

          mediaRecorder.start();
          blinker.style.display = "block";
          listeningText.setAttribute("visible", true);
          append("üéôÔ∏è Aufnahme l√§uft...");
        } catch (err) {
          isRecording = false;
          console.error("Mikrofon-Fehler:", err);
        }
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
      }

      // Web: Maus & Trigger halten
      recordButton.addEventListener("mousedown", startRecording);
      recordButton.addEventListener("mouseup", stopRecording);
      recordButton.addEventListener("mouseleave", stopRecording);
      recordButton.addEventListener("triggerdown", startRecording);
      recordButton.addEventListener("triggerup", stopRecording);

      // Web: Leertaste
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space") startRecording();
      });
      document.addEventListener("keyup", (e) => {
        if (e.code === "Space") stopRecording();
      });

      // VR: Lucy kleiner machen
      AFRAME.scenes[0].addEventListener("enter-vr", () => {
        lucy.setAttribute("scale", "0.5 0.5 0.5");
      });
      AFRAME.scenes[0].addEventListener("exit-vr", () => {
        lucy.setAttribute("scale", "1.5 1.5 1.5");
      });

      // Rollenauswahl aus Men√º
      function setRole(role) {
        roleSelect.value = role;
        append(`üé≠ Rolle ge√§ndert: ${role}`);

        const isPhoneMode = role === "telefon";
        const callBtn = document.getElementById("simpleCallButton");
        const lucyEl = document.getElementById("lucy");

        // Sichere Steuerung mit Timeout-Fallback f√ºr VR
        if (isPhoneMode) {
          callBtn.setAttribute("visible", true);
          lucyEl.setAttribute("visible", false);
          // zus√§tzlich skaliere Lucy auf 0 (VR-Fallback)
          lucyEl.setAttribute("scale", "0 0 0");
        } else {
          callBtn.setAttribute("visible", false);
          lucyEl.setAttribute("visible", true);
          lucyEl.setAttribute("scale", "1.5 1.5 1.5");
        }
      }

      // üìû Klingelton abspielen
      function playRingtone() {
        return new Promise((resolve) => {
          const audio = new Audio(
            "https://raw.githubusercontent.com/Sleek-AR/lucy-simulator/main/public/sounds/ringtone-126505.mp3"
          );
          audio.play();
          setTimeout(() => {
            audio.pause();
            resolve();
          }, 3000);
        });
      }

      // üìû Button-Logik
      document
        .getElementById("simpleCallButton")
        .addEventListener("click", () => {
          append("üìû W√§hle: +43 660 3262626");
          playRingtone().then(() => {
            append("üîî Klingelton abgespielt. Warte auf Verbindung...");
          });

          // ‚è±Ô∏è Nach 10 Sekunden automatisch die Aufnahme starten
          setTimeout(() => {
            append("‚úÖ Verbindung aufgebaut!");
            speak(
              "Willkommen beim Bewerbungstraining. Wie kann ich Ihnen helfen?"
            );

            // Aufnahme starten, wie bei Leertaste oder Button
            startRecording();
          }, 10000); // 10 Sekunden
        });
    </script>
  </body>
</html>
